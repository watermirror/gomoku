# Feature Specification: 研学模式 (Self-Study Mode)

**Feature Branch**: `001-self-study-mode`
**Created**: 2026-02-12
**Status**: Draft
**Input**: User description: "实现研学模式：点击研学模式按钮后弹出禁手规则选择浮层，选定后进入游戏，玩家轮流扮演黑白双方落子，支持任意悔棋，五子连线宣布胜利，使用滑动动画切换画面"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 进入研学模式并下棋 (Priority: P1)

玩家在标题画面点击"研学模式"按钮，弹出禁手规则选择浮层（默认全部选中），确认后棋盘以滑动动画切换到对局画面。玩家轮流扮演黑方和白方在棋盘上落子，直到一方五子连线获胜。

**Why this priority**: 这是研学模式的核心功能，没有这个能力其他一切交互都无意义。

**Independent Test**: 可以通过启动应用 → 点击研学模式 → 选择规则 → 确认 → 在棋盘上交替落子 → 形成五子连线来完整测试，验证从进入到胜负判定的完整流程。

**Acceptance Scenarios**:

1. **Given** 标题画面已显示, **When** 玩家点击"研学模式"按钮, **Then** 弹出禁手规则选择浮层，显示三个规则选项（3-3 禁手、4-4 禁手、长连禁手），默认全部选中
2. **Given** 禁手规则选择浮层已打开, **When** 玩家点击"开始"按钮, **Then** 浮层消失，标题面板和按钮以滑动动画退出，棋盘滑动到窗口左侧，右侧栏从右侧滑入
3. **Given** 对局画面已就绪且当前为黑方回合, **When** 玩家点击棋盘上的空位, **Then** 黑子落在该位置，回合切换为白方，右侧栏信息更新
4. **Given** 对局进行中, **When** 一方形成五子连线, **Then** 右侧栏显示该方胜利信息，棋盘禁止继续落子

---

### User Story 2 - 禁手规则选择 (Priority: P1)

玩家在进入研学模式前，通过浮层选择本局生效的禁手规则。可以自由勾选/取消三种禁手规则的任意组合，也可以全部取消实现无禁手对局。

**Why this priority**: 禁手规则选择是用户进入游戏的必经环节，与核心流程不可分割。

**Independent Test**: 可以通过打开浮层 → 调整勾选状态 → 确认 → 验证对局中禁手规则是否按选择生效来测试。

**Acceptance Scenarios**:

1. **Given** 禁手规则选择浮层已打开且默认全选, **When** 玩家取消勾选"3-3 禁手", **Then** 该选项变为未选中状态，其余两项保持选中
2. **Given** 禁手规则选择浮层已打开, **When** 玩家点击"取消"按钮, **Then** 浮层消失，回到标题画面，不进入对局
3. **Given** 玩家已选择仅启用"长连禁手"并开始对局, **When** 黑方落子形成三三（双活三），**Then** 落子被允许（因为 3-3 禁手未启用）
4. **Given** 玩家已选择全部启用禁手并开始对局, **When** 黑方尝试在禁手位置落子, **Then** 落子被拒绝，回合不切换

---

### User Story 3 - 悔棋 (Priority: P2)

玩家在对局过程中或胜负已分后，可以点击"悔棋"按钮撤回最后一手棋。胜负后悔棋可以使棋局恢复到进行中状态继续下棋。

**Why this priority**: 悔棋是研学模式的关键辅助功能，允许玩家自由探索不同走法，但对局核心流程不依赖它。

**Independent Test**: 可以通过落子后点击悔棋按钮来测试，验证棋子被移除、回合切换回来、以及胜负后悔棋恢复状态。

**Acceptance Scenarios**:

1. **Given** 棋盘上已有若干棋子, **When** 玩家点击"悔棋"按钮, **Then** 最后一手棋被移除，回合切换回上一方，落子计数减少
2. **Given** 一方已获胜（五子连线）, **When** 玩家点击"悔棋"按钮, **Then** 最后一手棋被移除，棋局恢复为进行中状态，棋盘重新启用交互
3. **Given** 棋盘上没有任何棋子（初始状态）, **When** 玩家查看悔棋按钮, **Then** 悔棋按钮处于禁用状态

---

### User Story 4 - 返回标题画面 (Priority: P2)

玩家在对局中或胜负后，可以点击"返回"按钮以滑动动画切换回标题画面。返回后棋局数据被清除。

**Why this priority**: 退出功能是完整交互闭环的必要组成部分，但不影响对局核心体验。

**Independent Test**: 可以通过在对局中点击返回 → 验证动画播放 → 验证标题画面恢复来测试。

**Acceptance Scenarios**:

1. **Given** 对局画面显示中, **When** 玩家点击"返回"按钮, **Then** 右侧栏向右滑出，棋盘滑回中央，标题面板和按钮从左侧滑入
2. **Given** 退场动画播放完毕, **When** 标题画面恢复, **Then** 棋盘清空，之前的棋局数据不再保留，可以重新开始新对局

---

### Edge Cases

- 禁手规则浮层打开时，玩家未做任何修改直接点击"开始"，应使用默认全选配置正常进入对局
- 动画播放过程中，玩家的所有点击操作应被遮盖层屏蔽，不会触发任何交互
- 棋盘下满所有 225 个位置且无五子连线时，应判定为和局
- 落子到已有棋子的位置应被忽略，不产生任何效果
- 黑方只有一手棋且当前为白方回合时，悔棋应撤回黑方的唯一一手棋

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在标题画面的"研学模式"按钮被点击后，弹出一个禁手规则选择浮层
- **FR-002**: 禁手规则选择浮层必须包含三个可勾选选项：3-3 禁手、4-4 禁手、长连禁手，默认全部选中
- **FR-003**: 禁手规则选择浮层必须包含"开始"和"取消"两个按钮
- **FR-004**: 点击"取消"按钮必须关闭浮层并回到标题画面，不进入对局
- **FR-005**: 点击"开始"按钮必须关闭浮层并按选定的禁手规则配置创建对局，触发进场动画
- **FR-006**: 进场动画必须将标题面板和模式按钮滑出屏幕，将棋盘从居中滑动到窗口左侧，将右侧栏从窗口右侧外滑入
- **FR-007**: 退场动画必须将右侧栏滑出屏幕，将棋盘从左侧滑回居中，将标题面板和按钮从左侧滑入恢复标题画面
- **FR-008**: 所有动画播放期间必须使用遮盖层屏蔽用户交互
- **FR-009**: 对局中黑先白后交替落子，玩家点击棋盘空位落子
- **FR-010**: 落子后系统必须判定是否形成五子连线，若是则宣布该方胜利
- **FR-011**: 对局中必须在右侧栏显示当前回合方、落子计数信息
- **FR-012**: 胜负后必须在右侧栏显示获胜方信息
- **FR-013**: 对局中有棋子时必须提供可用的"悔棋"按钮，无棋子时禁用
- **FR-014**: 悔棋必须撤回最后一手棋，包括在胜负已分后也能悔棋使棋局恢复进行中状态
- **FR-015**: 必须提供"返回"按钮，点击后触发退场动画回到标题画面
- **FR-016**: 返回标题画面后，对局数据必须被完全清除
- **FR-017**: 落子合法性必须遵循选定的禁手规则配置（仅对黑方生效的三三、四四、长连禁手）

### Key Entities

- **对局 (Game)**: 代表一局研学模式棋局，包含棋盘状态、落子历史、禁手规则配置、当前回合方、胜负状态
- **禁手规则配置**: 三个布尔开关（3-3 禁手、4-4 禁手、长连禁手），决定本局的落子合法性检查规则
- **右侧栏信息面板**: 展示对局状态信息和操作按钮（悔棋、返回）的界面区域

## Assumptions

- 禁手规则选择浮层以模态方式覆盖在标题画面上方，不需要额外的滑动动画（简单地显示/隐藏即可）
- 浮层的视觉风格与现有 UI 保持一致（白色背景、黑色边框）
- 悔棋每次撤回最后一手棋（严格的最后一手），不论是黑棋还是白棋
- 和局判定沿用现有逻辑（棋盘满 225 手）
- 研学模式不包含计时功能

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从点击"研学模式"按钮到可以落第一手棋，整个流程（含浮层选择和动画）在 5 秒内完成
- **SC-002**: 用户可以在任何对局状态下（进行中或胜负后）成功执行悔棋操作
- **SC-003**: 所有画面切换（进场、退场）均伴随流畅的滑动动画，无跳帧或卡顿
- **SC-004**: 用户首次使用时能够在不阅读说明的情况下完成一局完整对局（进入 → 下棋 → 胜负 → 返回）
- **SC-005**: 禁手规则选择正确反映到对局中——启用的禁手规则能正确阻止黑方违规落子
